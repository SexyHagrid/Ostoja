<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="Zad2.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="Aktualnosci.css" media="screen" />
  </head>
  <body onload="onStart()">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <script>
      var data = {};

      function onStart() {
        // Pobieramy z bazy danych id i rolę użytkownika
        xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            var result = this.responseText.split('|');
            data.userID = parseInt(result[0]);
            data.userRole = parseInt(result[1]);

            loadData();
            showEditorMenu();
          }
        }
        var sessionID = getSessionID();
        xhttp.open('GET', 'uzytkownik.php?sessionID=' + getSessionID(), true);
        xhttp.send();        
      }

      // Pobieramy uchwały z bazy danych i je wyświetlamy
      function loadData() {
        xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            var tbody = document.getElementById("resolutionContent");
            var template = document.querySelector('#resolutionTemplate');

            var resolutionsResponse = this.responseText.split('||');
            for (var i = 0; i < resolutionsResponse.length; i++) {
              var resolution = resolutionsResponse[i].split('|');
              var resolutionID = resolution[0];
              var resolutionText = resolution[1];
              var resolutionImage = resolution[2];
              var resolutionAuthor = resolution[3];

              //Sprawdzamy, czy aktualność istnieje (php zwraca nam jedną pustą za dużo)
              if (resolutionID == '') {
                break;
              }

              // Tworzymy uchwałę: numer uchwały, treść oraz obrazek (jeżeli jest)
              var clone = template.content.cloneNode(true);
              var h3 = clone.querySelectorAll('h3');
              var label = clone.querySelectorAll('label');
              var button = clone.querySelectorAll('button');

              h3[0].textContent = "Aktualność nr. " + resolutionID;
              label[0].textContent = resolutionText;

              // Tworzymy obrazek (jeżeli jest)
              if (resolutionImage != ' ') {
                var image = clone.querySelectorAll('img');
                image[0].src = resolutionImage;
              }

              // Sprawdzamy czy użytkownik jest adminem/autorem uchwały
              // Jeżeli tak -> wyświetlamy przyciski do edycji i usunięcia
              if (isUserTheAdmin() || isUserTheAuthor(resolutionAuthor)) {
                button[0].setAttribute('data-id', resolutionID);
                button[0].onclick = function(event) {
                  editResolution(event.target.getAttribute('data-id'));
                }
                button[0].style.display = "block";

                button[1].setAttribute('data-id', resolutionID);
                button[1].onclick = function(event) {
                  deleteResolution(event.target.getAttribute('data-id'));
                }
                button[1].style.display = "block";
              }

              tbody.appendChild(clone)
            }
          }
        }
        xhttp.open('GET', 'aktualnosci.php', true);
        xhttp.send();
      }

      function showEditorMenu() {
        if (data.userRole == 1 || data.userRole == 2) {
          var editorMenu = document.getElementById("editorMenu");
          editorMenu.style.display = "block";
        }
      }

      function isUserTheAdmin() {
        return data.userRole == 1;
      }

      function isUserTheAuthor(author) {
        return parseInt(author) == data.userID;
      }

      function addResolution() {
        document.location.href = "aktualnosci_dodaj.html";
      }

      function editResolution(uchwalaID) {
        document.location.href = "aktualnosci_edytuj.html?id=" + uchwalaID;
      }

      function deleteResolution(resolutionID) {
        var answer = window.confirm("Czy na pewno chcesz usunąć aktualnosc?");
        if (answer) {
          xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
            if (this.readyState == 4) {
              if (this.responseText == "SUCCESS") {
                alert('Aktualność została usunięta');
                window.location.reload(true);
              } else {
                alert('Błąd podczas usuwania aktualności');
              }
            }
          }
          xhttp.open('GET', 'aktualnosci_usun.php?id=' + resolutionID, true);
          xhttp.send();
        }
      }

      function getSessionID() {
        return localStorage.getItem('sessionID');
      }
    </script>

    
    <div class="container">
        <div class="row">
          <div class="col-3">
            <a href="Zad2.html"><img src="logo.png" alt="Logo"></a>
          </div>
          <div class="col-8">
            <p>Aktualności</p>
          </div>
          <div class="col-1">
            <a href="logout.php"><p>Wyloguj</p></a>
          </div>
          
          <div class="row justify-content-start">
            <div class="col">
              <div id="editorMenu" style="display: none;">
                <button onclick="addResolution()">Dodaj aktualność</button>
              </div>
                <div class="row row-upper">
                    <h1>Aktualności</h1>
                </div>
                <div id="resolutionContent">

                </div>
            </div>
          </div>
          <div class="w-100"></div>
          <div class="col-6">
            <a href="Faq.html"><p>Faq</p></a>
          </div>
          <div class="col-6">
            <a href="Kontakt.html"><p>Kontakt</p></a>
          </div>
        </div>
      </div>  

      <template id="resolutionTemplate">
        <div class="row row-akt">
          <div><h3></h3></div>
          <label></label>
          <img>
          <button style="display: none;">Edytuj</button>
          <button style="display: none;">Usuń</button>
        </div>
      </template>
</body>
</html>